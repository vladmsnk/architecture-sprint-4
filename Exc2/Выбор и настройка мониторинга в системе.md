#### Анализ системы

Рассматриваем текущую архитектуру системы до выполнения плана из Exc1

Компоненты архитектуры, которые требуют мониторинга:
1) экземпляр RabbitMQ
  - необходимо понимать размер очереди, скапливается ли лаг
  - как быстро обрабатываются сообщения и как часто возникают ошибки при обработке сообщений
  - утилизация CPU и RAM
  - активные соединения, как часто происходит обрыв соединений
  - добавление алертинга на случаи, когда происходят ошибки при обработке сообщений
  На такие случаи необходимо реагировать моментально
2) MES API
   - не хватает информации о том, как долго обрабатываются запросы на подсчет стоимости заказов
   - необходимо понимать насыщенность процесса подсчета заказов
   - быстрота отображение заказов для операторов, необходимо понять, 
   почему происходит долгая загрузка страницы с заказами для операторов
   - насколько сильно загружен сервис, хватает ли ему ресурсов
   - отслеживание ошибок при проставлении статусов заказов операторами
   Важно понимать, что происходит с заказами после того, как операторы завершили свою работу
3) Shop API 
   - скорость обработки запросов на создание заказов
   - насколько загрузка файлов загружает систему
   - насколько работа редактора 3D моделей загружает систему
   - частота ошибок при создании заказов
4) S3 хранилище
   - понимать размер S3 хранилища
   - скорость загрузки файлов в S3
   - скорость скачивания файлов из S3

#### Мотивация

Важно отслеживать нестандартное поведение системы, так как такое поведение приводит к потере клиентов и денег.

Например, ситуации, когда из-за недоступности очереди сообщений не были доставлены события завершения заказов, приводят к тому, 
что клиенты не получают уведомления о завершении заказа. Такие заказы могут быть отменены клиентами, что приведет к потере денег.

Введение мониторинга позволит разработчикам оперативно реагировать на подобные ситуации и быстро устранять проблемы. 
Тем самым уменьшится количество потерянных клиентов и денег.


#### Выбор подхода к мониторингу

1) экземпляр RabbitMQ
- использование подхода RED 
  - измеряем скорость публикации и обработки сообщений
  - измеряем количество ошибок при обработке сообщений. Также измеряем ошибки подключения к RabbitMQ
  - замеряем размер очереди и задержку между публикацией и обработкой сообщений

2) MES API
- использование подхода RED
  - измеряем Request Rate — количество запросов в секунду, поступающих на подсчет стоимости заказов
  - измеряем Error Rate — количество ошибок при подсчете стоимости заказов
  - измеряем Duration — время обработки запросов на подсчет стоимости заказов

3) Shop API
- использование подхода "Четыре золотых сигнала"
  - используем метрику Latency для отслеживания времени обработки запросов на создание заказов или загрузку файлов
  - также используем latency при взаимодействии с графическим редактором
  - измеряем количество запросов в секунду (traffic), поступающих на эндпоинты Shop API и отслеживаем резкое увеличение трафика
  - измеряем (Error Rate) — количество 500 ошибок при взаимодействии с Shop API  
  - измеряем saturation — насколько загружен сервис, хватает ли ему ресурсов. Отслеживаем утилизацию CPU и RAM

4) S3 хранилище
- использование подхода USE
  - Utilization: измеряем скорость обработки запросов на загрузку и скачивание файлов. Также измеряем размер S3 хранилища
  - Saturation: измеряем утилизацию RAM
  - Errors: измеряем количество ошибок при загрузке и скачивании файлов

#### Выбор метрик

Метрики для мониторинга RabbitMQ:
- Message publish rate 
- Message delivery rate
- Total number of messages
- Number of consumers - Количество потребителей для кокретной очереди
- Memory used - Bytes in RAM used by a RabbitMQ node

Метрики для мониторинга MES:
- Number of requests (RPS) for MES API
- Number of HTTP 500 for MES API
- Number of tasks from price counting
- Number of simultanious sessions for MES API

Shop API:
- Response time (latency) for shop API
- Number of requests (RPS) per user for internet shop API
- Number of HTTP 500 for shop API
- CPU % for shop API
- Memory Utilisation for shop API
Дополнительно, можно отслеживать метрику "количество заказов за определенный промежуток времени". 
Данная метрика, позволит увидеть ситуации, когда количество создаваемых заказов значительно упало, 
что может свидетельствовать о проблеме

S3 хранилище:
- Size of S3 storage
- Memory Utilisation for S3
- Number of HTTP 500 for S3

#### План действий

Будем использовать технологии Prometheus и Grafana для интеграции мониторинга из-за простоты интеграции

1) Поднять экземпляр Prometheus
2) Поднять экземпляр Grafana

3) Интегрировать мониторинг для экземпляра RabbitMQ.
Пользуемся [документацией](https://www.rabbitmq.com/docs/prometheus)
- включение плагина rabbitmq_management
- установить RabbitMQ Exporter (сборщик метрик)
- настроить экземпляр Prometheus на сбор метрик с экспортера
- отобразить дашборды в графана

4) Интегрировать мониторинг для MES API
Пользуемся [документацией](https://prometheus.io/docs/prometheus/latest/getting_started/)
Для метрик RPC и Errors добавляем лейблы на каждый эндпоинт

- В каждый хендлер сервиса MES API добавляем объект счетчика, при поступлении запроса увеличиваем счетчик
- На каждый 500й код ответа, добавляем объект счетчика
- Количество задач подсчёта стоимости отслеживаем с помощью Gauge
- Количество активных сессий отслеживаем с помощью Gauge
- определяем эндпоинт /metrics
- добавляем конфигурацию в prometheus для сбора метрик с эндпоинта /metrics сервиса MES API

5) Интегрировать мониторинг для Shop API
Для метрик Latency, RPC и Errors добавляем лейблы на каждый эндпоинт
- Добавляем метрику Histogram для измерения latency
- Используем CounterVec для подсчёта запросов rpc
- На каждый 500й код ответа, добавляем объект счетчика CounterVec
- настраиваем [Node Exporter](https://prometheus.io/docs/guides/node-exporter/) для сбора системных метрик
- в сервисе определяем эндпоинт /metrics
- добавляем конфигурацию в prometheus для сбора метрик с эндпоинта /metrics сервиса SHOP API

6) Интегрировать мониторинг в S3 хранилище
- Настроить Node Exporter для сбора данных об использовании ресурсов сервера (CPU, RAM)
- используем встроенный метрики S3 для получения информации по размеру хранилища и количеству 

7) Протестировать работоспособность мониторинга