#### Анализ системы

Рассматриваем текущую архитектуру системы до выполнения плана из Exc1

1) SHOP API

Проблемные места:
- методы обращения к внешним сервисам: БД, MES API
- загрузка файлов
- отправка/потребление сообщений из очереди
- графический редактор, если происходит рендер изображений на стороне бэкенда

Трассируем:
- входящие HTTP запросы со стороны фронта
- запросы в БД
- вызовы сервиса MES
- отправка/потребление сообщений из очереди
- работу рендеринга 3Д редактора

2) CRM API 

Проблемные места:
- методы обращения к внешним сервисам: БД, MES API
- отправка/потребление сообщений из очереди

Трассируем:
- входящие HTTP запросы со стороны фронта
- запросы в БД
- отправка/потребление сообщений из очереди

3) RabbitMQ

Проблемные места:
- переполнение очереди
- застревание сообщений в очереди

Трассируем:
- оборачиваем в трейс сообщение при отправке
- дополняем информацию в трейс при получении сообщения 

4) MES

Проблемные места:
- страница заказов для операторов 
- подсчет стоимости заказа, тяжелые запросы на подсчет
- конкуренция потоков за общие ресурсы

Что трассировать:
- Входящие HTTP-запросы или сообщения из ShopAPI, User API
- Обращения к БД MES.
- Внутренние вычисления

#### Мотивация

- Трейсинг позволит определить "бутылочное горлышко" системы, что сейчас сделать крайне сложно
- Также, благодаря трейсингу будет возможно быстро находить проблемные места при возникновении инцидента,
что сократит время восстановления 
- Позволит увидеть места, которые требуют оптимизации
- Повлияет на ключевые метрики стабильности, после обнаружения проблемных мест и их оптимизации

#### Предполагаемое решение
https://drive.google.com/file/d/1NiFoi3TKMpRi2Nn5yGav-iZrHyFyoy4A/view?usp=sharing

1) Интегрировать трассировку отдельным проектом для каждого сервиса. 
Перед тем, как начинать интеграцию — составить проект по интеграции, оценить его сроки. 
Интеграция не должна сломать текущий функционал.
2) Поднять контейнеры с Jaeger Service, Jaeger UI и Jaeger Collector
3) Настроить JaegerService  на сохранение трейсов в экземпляр Elasticsearch
4) В каждый сервис внедрить трассировку и подключить сбор трейсов с помощью библиотеки
5) Протестировать интеграцию трейсинга

#### Компромиссы

- Если приложение является сложно поддерживаемым монолитом, то интегрировать трейсинг будет крайне дорого
- Нет смысла интегрировать трейсинг в простое приложение, которое обрабатывает небольшое количество пользователей
- Если приложение не имеет четких внутренних границ. Трейсинг в данном случае будет бессмысленным, 
так как не будет указывать на точное место в коде приложения. (Например, вся логика исполняется в одной функции)
- Важна производительность. В таком случае собирать исключительно все трейсы будет слишком ресурсоемко 
и будет сказываться на производительности. Если трейсинг все-таки нужен, нужно настроить частичный сбор трейсов (только с ключевых процессов)
- Нехватка ресурсов для хранения большого объема трейсов

#### Аспекты безопасности
- Подключить Jaeger UI к корпоративной системе аунтификации, например, к SSO или LDAP
- Внедрение ролевого управления доступами RBAC (Role Based Access control) 
позволит ограничить группы лиц, которым доступен просмотр трейсов. 
- использовать TLS для передачи трейсов с сервисов в Jaeger Collector